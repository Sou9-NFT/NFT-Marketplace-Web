{% extends 'base.html.twig' %}

{% block title %}New Artwork{% endblock %}

{% block body %}
    <h1>Create new Artwork</h1>

    <div class="row">
        <div class="col-md-8">
            {{ form_start(form) }}
            {{ form_errors(form) }}

            {% if aiImageUsed %}
                <div class="alert alert-info">
                    <p>You're using an AI-generated image:</p>
                    <img src="{{ asset('uploads/artworks/' ~ artwork.imageName) }}" alt="AI Generated Image" class="img-thumbnail" style="max-width: 300px;">
                    <input type="hidden" name="ai_image_name" value="{{ artwork.imageName }}">
                    
                    <button type="button" class="btn btn-sm btn-danger mt-2" id="clearAiImage">
                        <i class="fas fa-times"></i> Remove AI image
                    </button>
                </div>
            {% endif %}
            
            {{ form_row(form.title) }}
            {{ form_row(form.description) }}
            {{ form_row(form.price) }}
            {{ form_row(form.category) }}

            {# Only show imageFile field if the form has it (not using AI image) #}
            {% if form.imageFile is defined %}
                {{ form_row(form.imageFile) }}
            {% endif %}
            
            {# AI generator section (only show if not already using an AI image) #}
            {% if not aiImageUsed %}
                <div class="ai-generator mb-4 mt-4">
                    <h3>Or generate an image with AI</h3>
                    <div class="form-group">
                        <label for="aiPrompt">Describe what you want to generate:</label>
                        <textarea id="aiPrompt" class="form-control" rows="3" placeholder="Describe the image you want to generate..."></textarea>
                    </div>
                    <button type="button" id="generateAiImage" class="btn btn-primary mt-2">
                        <i class="fas fa-robot"></i> Generate Image
                    </button>
                    <div id="aiImagePreview" class="mt-3"></div>
                    <div id="aiGenerationStatus"></div>
                </div>
            {% endif %}

            <div class="mt-4">
                <button class="btn btn-success">{{ button_label|default('Save') }}</button>
                <a href="{{ path('app_artwork_index') }}" class="btn btn-secondary">Back to list</a>
            </div>
            
            {{ form_end(form) }}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generateAiImage');
            const aiPrompt = document.getElementById('aiPrompt');
            const previewDiv = document.getElementById('aiImagePreview');
            const statusDiv = document.getElementById('aiGenerationStatus');
            const clearAiBtn = document.getElementById('clearAiImage');
            
            // Clear AI image button
            if (clearAiBtn) {
                clearAiBtn.addEventListener('click', function() {
                    fetch('{{ path('app_artwork_clear_ai_image') }}', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '{{ path('app_artwork_new') }}';
                        }
                    });
                });
            }
            
            // Generate image button
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    const prompt = aiPrompt.value.trim();
                    
                    if (!prompt) {
                        statusDiv.innerHTML = '<div class="alert alert-danger">Please enter a prompt</div>';
                        return;
                    }
                    
                    // Show loading status
                    statusDiv.innerHTML = '<div class="alert alert-info">Generating image, please wait...</div>';
                    generateBtn.disabled = true;
                    
                    // Send the generation request
                    fetch('{{ path('app_artwork_generate') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: 'prompt=' + encodeURIComponent(prompt)
                    })
                    .then(response => response.json())
                    .then(data => {
                        generateBtn.disabled = false;
                        
                        if (data.success) {
                            // Show the generated image
                            statusDiv.innerHTML = '<div class="alert alert-success">Image generated successfully!</div>';
                            previewDiv.innerHTML = `
                                <div class="card" style="max-width: 300px;">
                                    <img src="${data.path}" class="card-img-top" alt="Generated image">
                                    <div class="card-body">
                                        <p class="card-text">Generated from prompt: "${prompt}"</p>
                                        <a href="{{ path('app_artwork_new') }}?aiImage=${data.filename}" class="btn btn-primary">Use this image</a>
                                    </div>
                                </div>
                            `;
                        } else {
                            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                        }
                    })
                    .catch(error => {
                        generateBtn.disabled = false;
                        statusDiv.innerHTML = '<div class="alert alert-danger">Error communicating with server</div>';
                        console.error('Error:', error);
                    });
                });
            }
        });
    </script>
{% endblock %}
